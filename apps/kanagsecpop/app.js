function getKanagawa() {
  return require("heatshrink").decompress(atob("kUi4X/AAM3+8rnez6pL/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4AUiBA/AH8EIH4A/AH4AEgN62hC/AAk+1Wq1ZD/RwfqI4JI/AAcDIwRIC/4DB1/QR/hHEAAP/AAJNBJPbXDAAW1qtV//+SYJH/AAPVJAJKC9XwI+86I42rI4ZJC9pH2hxHG1WtJAtX9ZH1g5HHbIpIC9XAI+cBIAOv9RHE/ZHFAAN6JGkqI4PVJAms+pIHr2wI+UO1W//tVI4eg2ZHHSIJIygZHB/9Vq5IDg29JBPwJGPr/5HBAALaB1dtn+VJHd/I4P1HANUtWqyHvy5HIqv66BHvnZHB/o5Dv2q6VrI5NV9fAI90bI4LYDAANRr/9TAQAHq+vI90ObAXVHY2VSBVW1pHuR4SHKABNO2hHsh+/I4P9I6dVr2wI9cD+6QCbAwAOrXAJFftbC4ABvZHrlZHCbCoABtJHqhRHC/5HWqv0I9MC35HC6pHWq+QJFOvI4X1SC9f4BHol7Ybqt/I9ELI4bYXAAP8Fx1cI68CI4bYYqtX+AtMgPqwBIX35HC/pHYqtf4AsLj2q1BHX96QDI7NVv4sLtWq1RXMABUbbDoAB1gsK9RHB0BHWh5HDbDVVqWQI5mqI60DbD9VpdAa5aQYt5HD6pIblorInRHC1ZHWjbYfAAPsFY8KI4WqwBHVgW/bD9Vq/AFY5HD1iQW97YgqtbFIsH6pHD1RHWnbYhqtsE4Uf9RFEAAOgI6sOI4bYdbIPwE4NqIw2q1aQW35HD+pIdrwmB9W1qv+JAuAI6s/bEVVvBHBNQd6bHwAB+er6rhE9RHB1LYWI4jYeqtW14IGJAXAI6sbSElbBA7YYgRHEWwgAbWItXAIJIBbDf9I79XNItpqta1WoI6sfbElVr4GF9tVtWq0hHUge/I4a3FADd1S4u1bIWAJClrSEtVbItebIWqI6kez6QlbIN9AwdtqpHB1hHTh2vI4f9SELZB8oFCq2VrxIB2BIT1TYEWwrZe2oFCvNVtTZVnWrSE1dRgIFCq6QD1BHSgeq35IDI8LZCRgJODI4LZU9SQE+pHhq4CB8oHDrRICbCaQovrVCA4dqbKkC1SQE6pIiIoNfTAiQCyDYSSAn9I8VbAQNlA4dWbKkKSFPlSYYACrxHB1hHQgYUBSE9aNgNeBAl6bKdqSFOpAQNtBAnqbKUOSFW1bI1XGYOgI58BCYOvSEw+BAYLZDcANeGgPAJB86CYJHDSEdq14DBvoHCtdVvWq1BHPgyQGI8VW1TZGAwI0ByBIP9SQF+qQjbIVbKAfVKQOrI58KI4OrSE1a1WtAgNlBAV5KQWgJB5HB1W/SEtXFILWBq/VBIWlbIVAI506SFKFB1YEBrIICrybC1hHOgSQC16QlHgOqRINVFAdpqvq1WQJB0qJASQlbAWqawNWBIVWytWBYXAI5kOSFLYB1WtAoN1BIVrBYeq2BIMCASQmbAWq2qWBSYIDB2qQDJBsKSFDYD1RODAYN7SAhIMgYQD36QTPAQAN9QpCbIXQnYbCSAhIKt9AlTZGSCF5CB96FIZdBr8AkpUGAAOAI48B4/CB4bZDGx9WyoQPFIepA4NggYMCrxHEJBMPgZZESCeZCB45E2pPBoE1Bg4ABIgnq14DBkEOBwerSCV4SAjIBbBurA4N8gQMCrRHF1BHDgXAvXAgOAgwPD06QRq0PAod5CBLLFSANVwHlSBOQJAcOgEHoELgEaB4e/SCPwLId6SohYFHIoIBrcpTo4AB1jZEhkAhcP0EAbIyQPrMGAgVO/IPIqnqHImlBIPrKpOqI4kA+EAlWq4EKB4evSCOAkIuC2KQJQQwUC6oNCtQNFwBHEgfAgG1rEByzZFSB98gUVAgOsjIPIrw5F1oJBsoNJ2CQFh4BBqvwtoTESCFWoE9AgNogaQIq7KGRoNWBwbmF0BHFgEggO1q+rqtabId//pIOsEBysVpcASBI5FSA4zDAAOsawm/gE64E5fY7ZBe4YAKrUAhWv62QgCQIEgYADCAKQDTwuoawsPp37hxrI76QOqz8Bt/62kAhIPHfwgACX4NVvoOCtRHJgEshyFHD4d/SBtX3axB/97EgKQCq4PDoxHG1WlKxOkI4sBwE/I41WCgWpSB2v8EA//W4CQE9prGAApmFBIYdBAAsLgG/+r9J04LGAA1//+Qv/1siQEvZtDfgYAE1oeEbAWvIwwABkEPQg4lD35HO/+r/tWOQMbBQNano4FAAxZCCYQHB2BHIgcAt7YFU4u1I5deI4IAB6t4EYOrBQODEoSyDAAoQBGAugI5EAjkGSA9eEIZUGLIu/I4TqBwEAlvrq+gSAQgEAApvET4OoI5MAwByBG4y3D1cVJBVvSAdVr8Ah1V9ntgQlBqxHJSAifCegIAIjf/SA7ZEEIgAGrbYEJANX6tX9aUBD4oAG0oeCK4TYKga9BSA64EJBVTbApIBJYUAgwDBI5WqGYYFBbBc/SBDZEJAMBJBHvbAgAEYIPlG4QAJ14uFI5SQKXIurgDYMSAQACrEAhdV9RIOrQFBwBIKnaQJDIQAD6BXHbAYcGSAOVI5mq1tVqwEB0CQVOQ+9bBYcFr8AjZGMAAO1dAWoI5SQLMQQAFHgtebBNVsECI52qytq1WrI5aQLvQkHSQrYD/4aG/RHP1QRCwCQWVYRJIgANBvaQKqvVP4IAQ0CQXrQjJ1aJBqxHDMiYAH1hHLSBnqE5mvJAZkIrxHQ1BHMgKQKFZqTBSBhkND4ZHMgEKFZVqE5hhBAAQbIqyQQ2BIN96QCq4wFFZrYE+pkVAAhHNhyQCrx7B/YrDvQnMI4aQJq5HQ1JIN9aQBR4X/9orQbAisBAA5kNAAegI5kGF4NVGIeVFYVaExerSAn/95KGSCOqyBIMlf/+t/F4X+FgfqbB3+SgX62qQX1VAI5cC1//rZ4D/KQPC4JDBDAf+1qQX1CQMnX//p2CbIomMIQTbF0pIEtRIR0BHLgJ4CAAgrCryQOMAgABbQlWI6Oq4BILhx3G8osC9QkK1YSB95HF/xIESCWqbJkr/6SF6p0ORoP7VQ3+DQSQU1BHLge/F4v5OhyQCbA3//SQDVhYAH2BILjYvGXwSQWMYleI6Wq4BILSA3+SCH+I4//+obCI6erI5cO//vFgn9SCAXFMYfVDYNKJCegJBdvPA2VSB/6SBH7DQNXI6eqwBHKgW/PAv5SCABBAA/lDYMqI6epSBcbGA21SB/7I5H/bIJjMbKuvGAv+SBwRBSBKsC9TZghy9JSBevSBeVqtaI6mrSBdv/yQVCwqQHI6jZMgO/94sE9qQPCwoAE6tVvRIVSBcL/+/FgyQM36QK/oaNABOsJBfvGIosBSBmrSBvqJCuAI5UC3/7FgmVSDdaCgv6BYJRM1CQLnbZF/KQZ/waBCY3XqlQv5JLyBILl/+JAiQBryQX8piF1sQF4kBvQlJI5cD36vCSAhqLPgLvFDQpiE0gxHgpxH1FgJBcLYYqQPd4oAE6rYEI5BIBq5yG2RHLbIIyESARHLSBbYBrQRC1gyKgv6EgkO/hIM3/+SAotDABGvSBVVqxHOgEBJAmkvXAChcC//6SAlXI5eq/5dEAAhiBtQPB1J7MgE6bYWX2moCZkaYggtESBfvI4/tqteCAVAJBsOLQUG32ACZlr//rSAa+DSClVqoPCYZgACg5rCnWgCZp8BbQSQO1alEbBJHPAAN+EYOeUpsD34sB9WtqtaegQAJCYIVCAAnlbAeQI6AACnYPOgwsB/vvqtX2DZNSBDYDI6kAmAPOjQtC+tVtEHSJbZB97YIvWq2BHUUKIvD/UAgJIL3/+I43tbAWkI8pIE/2AA4J5BbKP7bAWgI80AlYwCFgcqI5OvbI/Vqtq1hHnJAeoA4cebJX/AIIAD+rYBI9MAtX+1YHEgxHI1bqBI4ntqtXI9UAh+tA4sB9TZJ/RHFqukI9QAJg7ZJ95HC9ZHBtBH0SQP+bI//AQXq6tVvRH1AAUVv/+/2voCOCcoO7R4N64BI4AAkDbIP/r+rI4XQI/sAhRHB+pGBqtewBH+gFrJAJHCq+wI/8D1///pHC0BH/gEH37ZCryP/AAUCJAPVryP/AAcO1f/9SP/AAkD/+9IX4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/AH4A/ACQA=="));
}



Graphics.prototype.setFontDarumadropOneRegular = function () {
  // Actual height 36 (42 - 7)
  return this.setFontCustom(
    E.toString(require('heatshrink').decompress(atob('ACHwAol+Aokf4AFDg4SEgP8CQl/AokPwASEJT1wAol8G4oxEv5KEn5KEn//CIn/DAYFF/4FJgILKDoQpDBY4FDj//TIcH//gDAilEn6rFAokAC4gAah/4AohLEAoIMDAoIMDKIP/UIUDAoP+QQgSDAoQfCOwISDOwOPCQQkBBwJgBEgOAIoZ8BgIYCn4PBcAQPCj4+BgYPBh7gBHoPAEIIYC+AICB4ISBVQQPB4F/GIf+JQoABN4i9DAoSxCCQR8CCQSPDOAJDBSoYFDGQTbEar4AJRgV8KAQwBn58CJwMPSokDJYS0BBAQeB8Z2DQQYYBQQauDR4jmCDDuAcAZQBJQYACSwgVBSs8DAQMwAQMBIIM/TwMBHYMPZ4RUBg7tCv/wgZjCj5UBMYTyBBwR8CwE/PgZvBPgfgCgJ8C/AUBDAX+AoIYD4auS/bgDDoIYCn///z5CCQT5CCQUBDARICv6CCOwMfPgKkeAoabCvBmBG4U/MwQCBVYUfAQMHB4ICCPgMH4BjC/+D+E/CQICB/kPYIJmBv+DLIJcBEYKxBDAOP/AYDQQIYDPgPDDAShCDAauN/75CAoRjD/1/EgISCFoKbC/+BAocDfIKncg4wCSwQqDKIStCAoRPCOwYLENAR8DfwR8CDAf/+YYE+AYDg/gn4YCgHAEAJEDZ4ITDHAImDHASJEVwYXCLAd/DAhLCDATIDGIQGBTYk/GwQZCJQYyBYwRlDAokfDAkDSoYAYIYpvBHoYFB/kBA4J1CgJFBMQXAv5ICDAMfH4KUB/kHPgJ7CgJ8BRwOfDAIzB/+HDAcf8P+DAQCBv/nGIIbBWoSnCw7HDDAK0Dg/wHIIeBJoI5BSwU/HIK6ChBMCVAiiFn6bbPwTBEG4Z3CBgYFCKAIFDHwYFCCQQFCCQV/AoIlCLYP1Z4SHB/EfY4J0BTYbHCFoI8Ev4rBv/H/E/SoMPTYMfSoXwGQIxCnC0EgjuDKIQSBDwIABHII9BAAISBKwQSCXQSuCBYgAXaQpJBIQY8HGwimEDwQYLJIaSCDAgXBgauBh4XBg52BgaMBh4aCXwLHE8CPDj/7AoIbBTQRMDAoTgEKQZKBAoYYCJYYFFPgK5Dg5pEgB7EADMD+EPFgQ+Bh4nCRIPvOQJdEPgZXEMYZ8CCQhQB//zOwIkBBQN/EoP/g/8HAU/wP/gYYBBAN/4AYBBAMf+E/DAN/JIMfDAMf84xGVAQxCJQ7gCMYSXC//xZoQlB/E/AoRJBgIFCgEMVDsPbIY+CAoowDWgJbBWgbnEfIpjBCQauC4FgKwP+R4N8DwUD/t/CQKxBCYKuC8AgBSoX4H4KVC/w/BJgV/4KVDcAZFBCASbEAohEDMYZdEv4FEZwIFDgF+VDsHZokH+KJDgf8PAKcDz57BTgXvUQcP+YYGJQkPKIcOgIkDABQ'))),
    46,
    atob("DBkiGhobHxkbHBsbDQ=="),
    50 | 65536
  );
};

Graphics.prototype.setFontDarumadropOneRegular_small = function () {
  // Actual height 15 (16 - 2)
  return this.setFontCustom(
    E.toString(require('heatshrink').decompress(atob('AAcwgEHwAECAAkHgEB/EAv8An/Ag/wgP8gEfC4PgC4oVD8EP/8A//wj8PgPwAgWA/PwBwfgg4lCEAegkEOg+B8/4j//wP/Agf8F4JKBAAlwuEPx4xB/Eej4dHh/nwF4NoeAuEeg8B814jnnCYN4DAZUBJ4PzNwsD+BZBKwKBBAgMIAQM//ED/+AAgMAvCmHj/hgP+nEf8eB904jw2B9/wjiuBg42DgQCB/wsBSoQdBJQPHgff+EZHYMPDAN8QwqmC4DRCj0BgPhNARtDFgIBBhzzEA4J8DCYM4jnzXomABwMHxg2FvxCBQwUQj1/XoRtCd4MPRAITBUgu8NoPAAgQABA'))),
    46,
    atob("BQoNCgoLDAoLCwsLBQ=="),
    20 | 65536
  );
};

// returns the temperature from weather json, if weather is provided trough 
//android/ios .. if no temperature is available, it wont be displayed.
//(returns empty string).
function getTemperature() {
  try {
    var weatherJson = storage.readJSON('weather.json');
    var weather = weatherJson.weather;
    return "Temp: " + Math.round(weather.temp - 273.15);
  } catch (ex) {
    return "";
  }
}

const storage = require('Storage');
require("Font8x16").add(Graphics);

var IMAGEWIDTH = 176;
var IMAGEHEIGHT = 176;
var energySave = false;
var batteryLvl = E.getBattery() + "%";
var temperature = getTemperature();

// timeout used to update every minute
var drawTimeout;

// schedule a draw for the next minute
function queueDraw() 
{
  if (drawTimeout) clearTimeout(drawTimeout);
  drawTimeout = setTimeout(function () 
  {
    drawTimeout = undefined;
    draw();
  }, (energySave == true ? 60000 : 1000) - (Date.now() % (energySave == true ? 60000 : 1000)));
}


function draw() {
  
  // sometimes, when gadgetbridge sends a message, the locked event is not thrown after the messages was displayed.
  // this checks the lock state manually and set the energysave.
  if (!energySave && Bangle.isLocked()) { energySave=true; }

  var date = new Date();
  var x = 10;
  var y = 2;

  g.reset();

  //draw main background image
  g.drawImage(getKanagawa(), 0, 0);

  // only update the batterylvl and temperature every 30 seconds or every minute if energysave is on
  if (date.getSeconds() % 30 == 0) 
  {
    batteryLvl = E.getBattery() + "%";
    temperature = getTemperature();
  }

  g.setFont("8x16");
  g.drawString(temperature, 4, g.getHeight() - 40);
  g.drawString(batteryLvl, g.getWidth() - g.stringWidth(batteryLvl) - 2, y);

  // work out locale-friendly date/time
  var h = date.getHours();
  var m = date.getMinutes();
  var s = date.getSeconds();

  var timeStr = h.toString().padStart(2, 0) + ':' + m.toString().padStart(2, 0);
  var timeStr2 = s.toString().padStart(2, 0);

  var dateStr = require("locale").date(new Date(), 1);
  dateStr = dateStr.replace(new RegExp('/', 'g'), '.');

  var nameOfCurrentDay = require("locale").dow(date, 0).toUpperCase();

  //---Hour and minute---
  g.setColor("#000000");
  g.setFont("DarumadropOneRegular");
  g.drawString(timeStr, x, y);

  // ---Seconds---
  x += 2 + g.stringWidth(timeStr);
  y += 24;

  //only print seconds if screen is active and not locked
  if (!energySave) {
    g.setFont("DarumadropOneRegular_small");
    g.drawString(timeStr2, x, y);
  }

  // ---draw date---
  y += 45;
  g.setColor("#000000");
  g.setFont("8x16");
  g.drawString(nameOfCurrentDay, 65, y);
  y += 15;
  g.drawString(dateStr, 65, y);

  queueDraw();
}


// Stop updates when LCD is off, restart when on
Bangle.on('lock', on => {
  if (on) {
    energySave = true;
  }
  else {
    energySave = false;
  }
  draw();
});

g.clear();
draw();

// Show launcher when middle button pressed
Bangle.setUI("clock");
Bangle.loadWidgets();
try {
  require("widget_utils").swipeOn(); // hide widgets, make them visible with a swipe
}
catch (ex) {
  require("widget_utils").hide();
}
