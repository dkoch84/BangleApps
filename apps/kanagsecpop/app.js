function getKanagawa() {
  return require("heatshrink").decompress(atob("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"));
}



Graphics.prototype.setFontDarumadropOneRegular = function () {
  // Actual height 36 (42 - 7)
  return this.setFontCustom(
    E.toString(require('heatshrink').decompress(atob('ACHwAol+Aokf4AFDg4SEgP8CQl/AokPwASEJT1wAol8G4oxEv5KEn5KEn//CIn/DAYFF/4FJgILKDoQpDBY4FDj//TIcH//gDAilEn6rFAokAC4gAah/4AohLEAoIMDAoIMDKIP/UIUDAoP+QQgSDAoQfCOwISDOwOPCQQkBBwJgBEgOAIoZ8BgIYCn4PBcAQPCj4+BgYPBh7gBHoPAEIIYC+AICB4ISBVQQPB4F/GIf+JQoABN4i9DAoSxCCQR8CCQSPDOAJDBSoYFDGQTbEar4AJRgV8KAQwBn58CJwMPSokDJYS0BBAQeB8Z2DQQYYBQQauDR4jmCDDuAcAZQBJQYACSwgVBSs8DAQMwAQMBIIM/TwMBHYMPZ4RUBg7tCv/wgZjCj5UBMYTyBBwR8CwE/PgZvBPgfgCgJ8C/AUBDAX+AoIYD4auS/bgDDoIYCn///z5CCQT5CCQUBDARICv6CCOwMfPgKkeAoabCvBmBG4U/MwQCBVYUfAQMHB4ICCPgMH4BjC/+D+E/CQICB/kPYIJmBv+DLIJcBEYKxBDAOP/AYDQQIYDPgPDDAShCDAauN/75CAoRjD/1/EgISCFoKbC/+BAocDfIKncg4wCSwQqDKIStCAoRPCOwYLENAR8DfwR8CDAf/+YYE+AYDg/gn4YCgHAEAJEDZ4ITDHAImDHASJEVwYXCLAd/DAhLCDATIDGIQGBTYk/GwQZCJQYyBYwRlDAokfDAkDSoYAYIYpvBHoYFB/kBA4J1CgJFBMQXAv5ICDAMfH4KUB/kHPgJ7CgJ8BRwOfDAIzB/+HDAcf8P+DAQCBv/nGIIbBWoSnCw7HDDAK0Dg/wHIIeBJoI5BSwU/HIK6ChBMCVAiiFn6bbPwTBEG4Z3CBgYFCKAIFDHwYFCCQQFCCQV/AoIlCLYP1Z4SHB/EfY4J0BTYbHCFoI8Ev4rBv/H/E/SoMPTYMfSoXwGQIxCnC0EgjuDKIQSBDwIABHII9BAAISBKwQSCXQSuCBYgAXaQpJBIQY8HGwimEDwQYLJIaSCDAgXBgauBh4XBg52BgaMBh4aCXwLHE8CPDj/7AoIbBTQRMDAoTgEKQZKBAoYYCJYYFFPgK5Dg5pEgB7EADMD+EPFgQ+Bh4nCRIPvOQJdEPgZXEMYZ8CCQhQB//zOwIkBBQN/EoP/g/8HAU/wP/gYYBBAN/4AYBBAMf+E/DAN/JIMfDAMf84xGVAQxCJQ7gCMYSXC//xZoQlB/E/AoRJBgIFCgEMVDsPbIY+CAoowDWgJbBWgbnEfIpjBCQauC4FgKwP+R4N8DwUD/t/CQKxBCYKuC8AgBSoX4H4KVC/w/BJgV/4KVDcAZFBCASbEAohEDMYZdEv4FEZwIFDgF+VDsHZokH+KJDgf8PAKcDz57BTgXvUQcP+YYGJQkPKIcOgIkDABQ'))),
    46,
    atob("DBkiGhobHxkbHBsbDQ=="),
    50 | 65536
  );
};

Graphics.prototype.setFontDarumadropOneRegular_small = function () {
  // Actual height 15 (16 - 2)
  return this.setFontCustom(
    E.toString(require('heatshrink').decompress(atob('AAcwgEHwAECAAkHgEB/EAv8An/Ag/wgP8gEfC4PgC4oVD8EP/8A//wj8PgPwAgWA/PwBwfgg4lCEAegkEOg+B8/4j//wP/Agf8F4JKBAAlwuEPx4xB/Eej4dHh/nwF4NoeAuEeg8B814jnnCYN4DAZUBJ4PzNwsD+BZBKwKBBAgMIAQM//ED/+AAgMAvCmHj/hgP+nEf8eB904jw2B9/wjiuBg42DgQCB/wsBSoQdBJQPHgff+EZHYMPDAN8QwqmC4DRCj0BgPhNARtDFgIBBhzzEA4J8DCYM4jnzXomABwMHxg2FvxCBQwUQj1/XoRtCd4MPRAITBUgu8NoPAAgQABA'))),
    46,
    atob("BQoNCgoLDAoLCwsLBQ=="),
    20 | 65536
  );
};

// returns the temperature from weather json, if weather is provided trough 
//android/ios .. if no temperature is available, it wont be displayed.
//(returns empty string).
function getTemperature() {
  try {
    var weatherJson = storage.readJSON('weather.json');
    var weather = weatherJson.weather;
    return "Temp: " + Math.round(weather.temp - 273.15);
  } catch (ex) {
    return "";
  }
}

const storage = require('Storage');
require("Font8x16").add(Graphics);

var IMAGEWIDTH = 176;
var IMAGEHEIGHT = 176;
var energySave = false;
var batteryLvl = E.getBattery() + "%";
var temperature = getTemperature();

// timeout used to update every minute
var drawTimeout;

// schedule a draw for the next minute
function queueDraw() 
{
  if (drawTimeout) clearTimeout(drawTimeout);
  drawTimeout = setTimeout(function () 
  {
    drawTimeout = undefined;
    draw();
  }, (energySave == true ? 60000 : 1000) - (Date.now() % (energySave == true ? 60000 : 1000)));
}


function draw() {
  
  // sometimes, when gadgetbridge sends a message, the locked event is not thrown after the messages was displayed.
  // this checks the lock state manually and set the energysave.
  if (!energySave && Bangle.isLocked()) { energySave=true; }

  var date = new Date();
  var x = 10;
  var y = 2;

  g.reset();

  //draw main background image
  g.drawImage(getKanagawa(), 0, 0);

  // only update the batterylvl and temperature every 30 seconds or every minute if energysave is on
  if (date.getSeconds() % 30 == 0) 
  {
    batteryLvl = E.getBattery() + "%";
    temperature = getTemperature();
  }

  g.setFont("8x16");
  g.drawString(temperature, 4, g.getHeight() - 40);
  g.drawString(batteryLvl, g.getWidth() - g.stringWidth(batteryLvl) - 2, y);

  // work out locale-friendly date/time
  var h = date.getHours();
  var m = date.getMinutes();
  var s = date.getSeconds();

  var timeStr = h.toString().padStart(2, 0) + ':' + m.toString().padStart(2, 0);
  var timeStr2 = s.toString().padStart(2, 0);

  var dateStr = require("locale").date(new Date(), 1);
  dateStr = dateStr.replace(new RegExp('/', 'g'), '.');

  var nameOfCurrentDay = require("locale").dow(date, 0).toUpperCase();

  //---Hour and minute---
  g.setColor("#000000");
  g.setFont("DarumadropOneRegular");
  g.drawString(timeStr, x, y);

  // ---Seconds---
  x += 2 + g.stringWidth(timeStr);
  y += 24;

  //only print seconds if screen is active and not locked
  if (!energySave) {
    g.setFont("DarumadropOneRegular_small");
    g.drawString(timeStr2, x, y);
  }

  // ---draw date---
  y += 45;
  g.setColor("#000000");
  g.setFont("8x16");
  g.drawString(nameOfCurrentDay, 65, y);
  y += 15;
  g.drawString(dateStr, 65, y);

  queueDraw();
}


// Stop updates when LCD is off, restart when on
Bangle.on('lock', on => {
  if (on) {
    energySave = true;
  }
  else {
    energySave = false;
  }
  draw();
});

g.clear();
draw();

// Show launcher when middle button pressed
Bangle.setUI("clock");
Bangle.loadWidgets();
try {
  require("widget_utils").swipeOn(); // hide widgets, make them visible with a swipe
}
catch (ex) {
  require("widget_utils").hide();
}
